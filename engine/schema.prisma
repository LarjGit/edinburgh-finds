generator client {
  provider = "prisma-client-py"
  interface = "asyncio"
}

datasource db {
  provider = "sqlite"
  url      = "file:../web/dev.db"
}

// TODO: When migrating to Supabase (PostgreSQL), replace entityType String with native enum:
//   enum EntityType { VENUE, RETAILER, COACH, INSTRUCTOR, CLUB, LEAGUE, EVENT, TOURNAMENT }
//
// TEMPORARY SQLite LIMITATION: SQLite doesn't support native Prisma enums.
// EntityType is currently stored as String but validated as Enum in application code.
// Valid values: VENUE, RETAILER, COACH, INSTRUCTOR, CLUB, LEAGUE, EVENT, TOURNAMENT

model Category {
  id          String       @id @default(cuid())
  name        String       @unique
  slug        String       @unique
  description String?
  image       String?
  listings    Listing[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Listing {
  id           String     @id @default(cuid())
  entity_name  String
  slug         String     @unique

  entityType   String     // Enum validated in application layer: VENUE, RETAILER, COACH, etc.
  categories   Category[]

  summary      String?
  attributes   String?
  discovered_attributes String?

  street_address String?
  city           String?
  postcode       String?
  country        String?
  latitude       Float?
  longitude      Float?

  phone        String?
  email        String?
  website_url  String?

  instagram_url String?
  facebook_url  String?
  twitter_url   String?
  linkedin_url  String?
  mainImage     String?

  opening_hours String?

  source_info      String?
  field_confidence String?
  external_ids     String?

  outgoingRelationships ListingRelationship[] @relation("SourceListing")
  incomingRelationships ListingRelationship[] @relation("TargetListing")

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([entityType])
  @@index([city])
  @@index([postcode])
  @@index([latitude, longitude])
  @@index([createdAt])
  @@index([updatedAt])
}

model ListingRelationship {
  id              String  @id @default(cuid())
  sourceListingId String
  targetListingId String
  type            String  // e.g., "teaches_at", "plays_at", "part_of"
  confidence      Float?  // Optional confidence score (0.0 - 1.0)
  source          String  // Which connector/source discovered this relationship

  sourceListing Listing @relation("SourceListing", fields: [sourceListingId], references: [id], onDelete: Cascade)
  targetListing Listing @relation("TargetListing", fields: [targetListingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sourceListingId])
  @@index([targetListingId])
  @@index([type])
}

model ExtractedListing {
  id                    String   @id @default(cuid())
  raw_ingestion_id      String
  source                String
  entity_type           String
  attributes            String?
  discovered_attributes String?
  external_ids          String?
  extraction_hash       String?
  model_used            String?

  raw_ingestion RawIngestion @relation(fields: [raw_ingestion_id], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([raw_ingestion_id])
  @@index([source])
  @@index([entity_type])
  @@index([extraction_hash])
  @@index([source, entity_type])
  @@index([createdAt])
}

model FailedExtraction {
  id               String   @id @default(cuid())
  raw_ingestion_id String
  source           String
  error_message    String
  error_details    String?
  retry_count      Int      @default(0)
  last_attempt_at  DateTime?

  raw_ingestion RawIngestion @relation(fields: [raw_ingestion_id], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([raw_ingestion_id])
  @@index([source])
  @@index([retry_count])
  @@index([last_attempt_at])
  @@index([retry_count, last_attempt_at])
}

model RawIngestion {
  id            String   @id @default(cuid())
  source        String   // e.g., "serper", "google_places", "osm"
  source_url    String   // Original URL or query that generated this data
  file_path     String   // Path to raw JSON file: engine/data/raw/<source>/<timestamp>_<id>.json
  status        String   // e.g., "success", "failed", "pending"
  ingested_at   DateTime @default(now())
  hash          String   // Content hash for deduplication
  metadata_json String?  // Additional metadata stored as JSON

  extractedListings ExtractedListing[]
  failedExtractions FailedExtraction[]

  @@index([source])
  @@index([status])
  @@index([hash])
  @@index([ingested_at])
  @@index([source, status])
  @@index([status, ingested_at])
}
