# ============================================================
# ENTITY SCHEMA - Common fields for all entity types
# ============================================================
# This is the single source of truth for the Entity model.
# All entity-specific schemas (if any) extend this.
#
# DO NOT EDIT GENERATED FILES (entity.py, schema.prisma)
# Edit this YAML file and regenerate instead.
# ============================================================

schema:
  name: Entity
  description: Base schema for all entity types (venues, retailers, coaches, etc.)
  extends: null

fields:
  # ------------------------------------------------------------------
  # IDENTIFICATION
  # ------------------------------------------------------------------
  - name: entity_id
    type: string
    description: Unique identifier (auto-generated)
    nullable: false
    required: false  # Auto-generated, so not required in input
    primary_key: true
    exclude: true  # Auto-generated, not for LLM extraction
    default: cuid()
    prisma:
      name: id  # Different name in Prisma
      attributes:
        - "@id"
        - "@default(cuid())"

  - name: entity_name
    type: string
    description: Official name of the entity
    nullable: false
    required: true
    index: true
    search:
      category: identity
      keywords:
        - name
        - called
        - named
    python:
      validators:
        - non_empty
      extraction_required: true

  - name: entity_class
    type: string
    description: "Universal entity classification (place, person, organization, event, thing)"
    nullable: true
    exclude: true  # Populated by extraction engine
    index: true
    prisma:
      name: entity_class
      type: "String"
    notes:
      - "Engine-Lens Architecture: Universal classification independent of vertical"
      - "Valid values: place, person, organization, event, thing"
      - "Determined by entity_classifier.py using deterministic rules"

  - name: slug
    type: string
    description: URL-safe version of entity name (auto-generated)
    nullable: false
    required: false
    unique: true
    index: true
    exclude: true  # Auto-generated
    default: null

  # ------------------------------------------------------------------
  # SUMMARY / DESCRIPTION
  # ------------------------------------------------------------------
  - name: summary
    type: string
    description: A short overall description of the entity summarising all gathered data
    nullable: true
    search:
      category: description
      keywords:
        - description
        - about
        - overview

  - name: description
    type: string
    description: Long-form aggregated evidence from multiple sources (reviews, snippets, editorial summaries)
    nullable: true
    search:
      category: description
      keywords:
        - description
        - details
        - about
        - information

  # ------------------------------------------------------------------
  # CLASSIFICATION
  # ------------------------------------------------------------------

  - name: raw_categories
    type: list[string]
    description: Raw free-form categories detected by the LLM (uncontrolled observational labels - NOT indexed, NOT used for filtering)
    nullable: true
    exclude: false  # Phase 1 primitive field from source APIs
    python:
      sa_column: "Column(ARRAY(String))"
      default: "default_factory=list"
    prisma:
      type: "String[]"
      attributes:
        - "@default([])"
    notes:
      - "Engine Purity: Opaque discovery signals only, NOT taxonomy"
      - "NO index, NO filtering, NO interpretation by engine"
      - "Used by lenses for mapping rules only"

  # ------------------------------------------------------------------
  # MULTI-VALUED DIMENSIONS (Engine-Lens Architecture)
  # ------------------------------------------------------------------
  # Dimensions are stored as Postgres text[] arrays with GIN indexes
  # for fast faceted filtering. Values are opaque to engine - lens
  # provides interpretation via canonical_values and mapping rules.

  - name: canonical_activities
    type: list[string]
    description: "Activities provided/supported (opaque values, lens-interpreted)"
    nullable: true
    exclude: true  # Populated by extraction engine
    python:
      sa_column: "Column(ARRAY(String))"
      default: "default_factory=list"
    prisma:
      type: "String[]"
      attributes:
        - "@default([])"
    notes:
      - "Postgres text[] array with GIN index for faceted filtering"
      - "Opaque to engine - lens provides interpretation"

  - name: canonical_roles
    type: list[string]
    description: "Roles this entity plays (opaque values, universal function-style keys)"
    nullable: true
    exclude: true  # Populated by extraction engine
    python:
      sa_column: "Column(ARRAY(String))"
      default: "default_factory=list"
    prisma:
      type: "String[]"
      attributes:
        - "@default([])"
    notes:
      - "Postgres text[] array with GIN index for faceted filtering"
      - "Internal-only facet (not shown in UI by default)"
      - "Universal function-style keys: provides_facility, sells_goods, provides_instruction, membership_org, produces_goods"

  - name: canonical_place_types
    type: list[string]
    description: "Physical place classifications (opaque values, lens-interpreted)"
    nullable: true
    exclude: true  # Populated by extraction engine
    python:
      sa_column: "Column(ARRAY(String))"
      default: "default_factory=list"
    prisma:
      type: "String[]"
      attributes:
        - "@default([])"
    notes:
      - "Postgres text[] array with GIN index for faceted filtering"
      - "Applicable to place entity_class only"

  - name: canonical_access
    type: list[string]
    description: "Access requirements (opaque values, lens-interpreted)"
    nullable: true
    exclude: true  # Populated by extraction engine
    python:
      sa_column: "Column(ARRAY(String))"
      default: "default_factory=list"
    prisma:
      type: "String[]"
      attributes:
        - "@default([])"
    notes:
      - "Postgres text[] array with GIN index for faceted filtering"
      - "Examples: membership, pay_and_play, free, private_club"

  # ------------------------------------------------------------------
  # FLEXIBLE ATTRIBUTE BUCKET
  # ------------------------------------------------------------------
  - name: discovered_attributes
    type: json
    description: Dictionary containing any extra attributes not explicitly defined in Listing or Entity models
    nullable: true
    python:
      sa_column: "Column(JSON)"

  - name: modules
    type: json
    description: "Namespaced module data (JSONB) organized by module key"
    nullable: true
    exclude: true  # Populated by extraction engine
    python:
      sa_column: "Column(JSON)"
    prisma:
      type: "Json"
    notes:
      - "Engine-Lens Architecture: Namespaced JSONB structure {module_key: {fields}}"
      - "Example: {core: {entity_id, entity_name, slug}, location: {street_address, city}}"
      - "Universal modules (core, location, contact, hours) + lens-specific modules (sports_facility, fitness_facility)"
      - "Module triggers determine which modules are required based on entity_class and canonical values"

  # ------------------------------------------------------------------
  # LOCATION
  # ------------------------------------------------------------------
  - name: street_address
    type: string
    description: Full street address including building number, street name, city and postcode
    nullable: true
    search:
      category: location
      keywords:
        - address
        - location
        - street

  - name: city
    type: string
    description: City or town
    nullable: true
    index: true
    search:
      category: location
      keywords:
        - city
        - town

  - name: postcode
    type: string
    description: Full UK postcode with correct spacing (e.g., 'SW1A 0AA')
    nullable: true
    index: true
    search:
      category: location
      keywords:
        - postcode
        - postal code
        - zip
    python:
      validators:
        - postcode_uk

  - name: country
    type: string
    description: Country name
    nullable: true
    search:
      category: location
      keywords:
        - country

  - name: latitude
    type: float
    description: WGS84 Latitude coordinate (decimal degrees)
    nullable: true

  - name: longitude
    type: float
    description: WGS84 Longitude coordinate (decimal degrees)
    nullable: true

  # ------------------------------------------------------------------
  # CONTACT
  # ------------------------------------------------------------------
  - name: phone
    type: string
    description: Primary contact phone number with country code. MUST be E.164 UK format (e.g. '+441315397071')
    nullable: true
    search:
      category: contact
      keywords:
        - phone
        - telephone
        - contact
    python:
      validators:
        - e164_phone

  - name: email
    type: string
    description: Primary public email address
    nullable: true
    search:
      category: contact
      keywords:
        - email
        - contact

  - name: website_url
    type: string
    description: Official website URL
    nullable: true
    search:
      category: contact
      keywords:
        - website
        - url
        - site
    python:
      validators:
        - url_http
      extraction_name: website

  # ------------------------------------------------------------------
  # SOCIAL MEDIA
  # ------------------------------------------------------------------
  - name: instagram_url
    type: string
    description: Instagram profile URL or handle
    nullable: true

  - name: facebook_url
    type: string
    description: Facebook page URL
    nullable: true

  - name: twitter_url
    type: string
    description: Twitter/X profile URL or handle
    nullable: true

  - name: linkedin_url
    type: string
    description: LinkedIn company page URL
    nullable: true

  # ------------------------------------------------------------------
  # OPENING HOURS
  # ------------------------------------------------------------------
  - name: opening_hours
    type: json
    description: "Opening hours per day. May contain strings or nested open/close times. Example: {'monday': {'open': '05:30', 'close': '22:00'}, 'sunday': 'CLOSED'}"
    nullable: true
    python:
      sa_column: "Column(JSON)"
    search:
      category: hours
      keywords:
        - hours
        - opening
        - times

  # ------------------------------------------------------------------
  # METADATA (excluded from extraction)
  # ------------------------------------------------------------------
  - name: source_info
    type: json
    description: "Provenance metadata: URLs, method (tavily/manual), timestamps, notes"
    nullable: true
    default: dict
    exclude: true
    python:
      default: "default_factory=dict"
      sa_column: "Column(JSON)"
      type_annotation: "Dict[str, Any]"

  - name: field_confidence
    type: json
    description: Per-field confidence scores used for overwrite decisions
    nullable: true
    default: dict
    exclude: true
    python:
      default: "default_factory=dict"
      sa_column: "Column(JSON)"
      type_annotation: "Dict[str, float]"

  - name: created_at
    type: datetime
    description: Creation timestamp
    nullable: true
    exclude: true
    python:
      sa_column: "Column(DateTime(timezone=True), nullable=False, server_default=func.now())"
    prisma:
      name: createdAt
      type: "DateTime"
      attributes:
        - "@default(now())"

  - name: updated_at
    type: datetime
    description: Last update timestamp
    nullable: true
    exclude: true
    python:
      sa_column: "Column(DateTime(timezone=True), nullable=False, server_default=func.now(), onupdate=func.now())"
    prisma:
      name: updatedAt
      type: "DateTime"
      attributes:
        - "@updatedAt"

  - name: external_ids
    type: json
    description: "External system IDs (e.g., {'wordpress': 123, 'google': 'abc'})"
    nullable: true
    exclude: true
    python:
      sa_column: "Column(JSON)"

# ------------------------------------------------------------------
# EXTRACTION-ONLY FIELDS (LLM)
# ------------------------------------------------------------------
extraction_fields:
  - name: rating
    type: float
    description: Average rating (typically 0-5 scale)
    nullable: true
  - name: user_rating_count
    type: integer
    description: Number of user ratings/reviews
    nullable: true
  - name: currently_open
    type: boolean
    description: Whether the entity is currently open
    nullable: true
  - name: external_id
    type: string
    description: External identifier from source system (e.g., Google Place ID, OSM ID)
    nullable: true
