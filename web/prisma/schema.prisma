generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  image       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  listings    Listing[] @relation("CategoryToListing")
}

model Listing {
  id                    String                @id @default(cuid())
  entity_name           String
  slug                  String                @unique
  entityType            String
  summary               String?
  attributes            String?
  discovered_attributes String?
  street_address        String?
  city                  String?
  postcode              String?
  country               String?
  latitude              Float?
  longitude             Float?
  phone                 String?
  email                 String?
  website_url           String?
  instagram_url         String?
  facebook_url          String?
  twitter_url           String?
  linkedin_url          String?
  mainImage             String?
  opening_hours         String?
  source_info           String?
  field_confidence      String?
  external_ids          String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  incomingRelationships ListingRelationship[] @relation("TargetListing")
  outgoingRelationships ListingRelationship[] @relation("SourceListing")
  categories            Category[]            @relation("CategoryToListing")

  @@index([entityType])
  @@index([city])
  @@index([postcode])
  @@index([latitude, longitude])
  @@index([createdAt])
  @@index([updatedAt])
}

model ListingRelationship {
  id              String   @id @default(cuid())
  sourceListingId String
  targetListingId String
  type            String
  confidence      Float?
  source          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  targetListing   Listing  @relation("TargetListing", fields: [targetListingId], references: [id], onDelete: Cascade)
  sourceListing   Listing  @relation("SourceListing", fields: [sourceListingId], references: [id], onDelete: Cascade)

  @@index([sourceListingId])
  @@index([targetListingId])
  @@index([type])
}

model ExtractedListing {
  id                    String       @id @default(cuid())
  raw_ingestion_id      String
  source                String
  entity_type           String
  attributes            String?
  discovered_attributes String?
  external_ids          String?
  extraction_hash       String?
  model_used            String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  raw_ingestion         RawIngestion @relation(fields: [raw_ingestion_id], references: [id], onDelete: Cascade)

  @@index([raw_ingestion_id])
  @@index([source])
  @@index([entity_type])
  @@index([extraction_hash])
  @@index([source, entity_type])
  @@index([createdAt])
}

model FailedExtraction {
  id               String       @id @default(cuid())
  raw_ingestion_id String
  source           String
  error_message    String
  error_details    String?
  retry_count      Int          @default(0)
  last_attempt_at  DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  raw_ingestion    RawIngestion @relation(fields: [raw_ingestion_id], references: [id], onDelete: Cascade)

  @@index([raw_ingestion_id])
  @@index([source])
  @@index([retry_count])
  @@index([last_attempt_at])
  @@index([retry_count, last_attempt_at])
}

model MergeConflict {
  id                 String   @id @default(cuid())
  field_name         String
  conflicting_values String
  winner_source      String
  winner_value       String
  trust_difference   Int
  severity           Float
  listing_id         String?
  resolved           Boolean  @default(false)
  resolution_notes   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([field_name])
  @@index([winner_source])
  @@index([severity])
  @@index([resolved])
  @@index([listing_id])
}

model RawIngestion {
  id                String             @id @default(cuid())
  source            String
  source_url        String
  file_path         String
  status            String
  ingested_at       DateTime           @default(now())
  hash              String
  metadata_json     String?
  extractedListings ExtractedListing[]
  failedExtractions FailedExtraction[]

  @@index([source])
  @@index([status])
  @@index([hash])
  @@index([ingested_at])
  @@index([source, status])
  @@index([status, ingested_at])
}
