{
  "track_id": "engine_lens_architecture_20260118",
  "title": "Engine-Lens Architecture Refactor",
  "created_at": "2026-01-18",
  "status": "ready_for_implementation",
  "priority": "critical",
  "estimated_hours": "24-33",
  "dependencies": [],
  "blocks": [],
  "tags": [
    "architecture",
    "refactor",
    "horizontal-scaling",
    "engine-lens-separation",
    "vertical-agnostic",
    "postgres-arrays",
    "faceted-taxonomy",
    "lens-layer",
    "domain-modules"
  ],
  "phases": {
    "total": 6,
    "completed": 0,
    "in_progress": 0,
    "pending": 6
  },
  "version": "v2.2",
  "success_criteria": [
    "Engine is 100% vertical-agnostic (zero references to sports, wine, coach, venue)",
    "Domain modules in lens only (sports_facility, wine_production not in engine)",
    "Postgres text[] arrays for dimensions with GIN indexes",
    "JSONB for modules (flexible attribute storage)",
    "All dimension_source use actual DB column names (canonical_activities, canonical_roles, canonical_place_types, canonical_access)",
    "Explicit module triggers with when: {facet, value} format",
    "Role facet (internal-only) maps to canonical_roles",
    "Universal role keys (provides_facility, sells_goods, provides_instruction, membership_org)",
    "Opaque dimension values (engine has zero interpretation)",
    "Prisma array filters (has, hasSome, hasEvery) on text[] arrays",
    "Derived grouping logic (AND within rule, OR across rules)",
    "Dimension array deduplication (dedupe_preserve_order)",
    "canonical_values_by_facet initialized with empty lists for all facets",
    "Second vertical (Wine Discovery) works with zero engine changes",
    "All existing tests pass"
  ],
  "key_architectural_principles": [
    "Engine remains 100% vertical-agnostic (no domain concepts, no value-based triggers, no domain modules)",
    "Dimensions are Postgres text[] (String[]) with GIN indexes; modules remain JSONB",
    "Lens owns all interpretation: canonical values, mapping rules, role facet, derived groupings, domain modules, module triggers",
    "Module triggers use explicit list format with when: {facet, value} where facet is lens-defined facet key (lens.facets)",
    "Extraction builds facet_to_dimension from lens.facets, initializes canonical_values_by_facet with empty lists, distributes values, dedupes deterministically"
  ]
}
