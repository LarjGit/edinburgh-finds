# System Design & Configuration Manual

*This document is the "System Bible" for Edinburgh Finds. It covers the architecture, configuration, operational tools, and logic of the entire repository. Generated by the `generate-system-manual` skill.*

---

## 1. System Overview

Edinburgh Finds is a hyper-local discovery platform built on a "Universal Entity Framework."

### High-Level Architecture
- **Monorepo Structure:**
    - `engine/`: Python-based data processing (Ingestion, Extraction, AI).
    - `web/`: Next.js frontend (User Interface).
    - `prisma/`: Shared database schema.
    - `docs/`: Specialized documentation.

---

## 2. The Data Engine ("The Brain")

The core value of the platform lies in its ability to turn messy web data into structured, trusted entities.

### 2.1 Taxonomy & Classification
*Source: `engine/config/canonical_categories.yaml`*

The system maps chaotic inputs to a strict taxonomy using a "Promotion Workflow."

**Taxonomy Logic:**
Raw categories extracted from sources are mapped to "Canonical Categories" based on regex patterns and keyword matching rules.
- **Workflow:**
    1.  **Extraction:** Raw categories are captured (e.g., "Tennis Club").
    2.  **Automatic Mapping:** Rules apply with confidence scores.
    3.  **Manual Review:** Unmapped categories are logged for review.
- **Principles:** "Fail open" (leave empty if no match), Multi-label support.
- **Configuration:** Defined in `mapping_rules`. Minimum confidence `0.7`.

**Current Hierarchy:**
- **Entity Types:** Venue, Retail, Coach, Club, Event
- **Sports:** Padel, Tennis, Squash, Badminton, Pickleball, Table Tennis
- **Venue Subtypes:** Sports Centre, Gym, Swimming Pool, Outdoor Pitch, Private Club, Public Facility
- **Future Expansion:** Golf, Climbing, Yoga, Martial Arts

### 2.2 Deduplication & Merging
*Source: `engine/extraction/deduplication.py`, `engine/extraction/merging.py`*

**Deduplication Strategy:**
The system uses a cascade of three strategies to identify duplicate listings:
1.  **External ID Matching (100% Confidence):** Matches exact IDs from sources like Google Places or OSM.
2.  **Slug Matching:**
    -   Exact match (1.0 confidence)
    -   Fuzzy similarity (>0.9 confidence) for typo tolerance.
3.  **Fuzzy Matching (Name + Location):**
    -   Combines name similarity (Token Sort Ratio) and geographic proximity (Haversine distance).
    -   Requires both name and location.
    -   Distance threshold: 200 meters.

**Merging & Trust Levels:**
When sources conflict, "Trust Levels" decide the winner.

| Source | Trust Score |
| :--- | :--- |
| manual_override | 100 |
| sport_scotland | 90 |
| edinburgh_council | 85 |
| google_places | 70 |
| serper | 50 |
| osm | 40 |
| open_charge_map | 40 |
| unknown_source | 10 |

### 2.3 The LLM Cache
*Source: `engine/extraction/llm_cache.py`*

Semantic caching minimizes costs and latency.
- **Cache Key:** SHA-256 hash of `raw_data` + `prompt` + `model_name`.
- **Storage:** `ExtractedListing` table in the database (`extraction_hash` column).
- **Hit:** Returns existing structured data without calling the LLM.
- **Miss:** Calls LLM, stores result with hash.

### 2.4 Pipeline Resilience
*Source: `engine/ingestion/retry_logic.py`, `engine/ingestion/rate_limiting.py`*

- **Retry Logic:** Implements exponential backoff.
    -   Decorator `@retry_with_backoff`.
    -   Configurable max retries (default 3), initial delay, and backoff factor.
    -   Raises `MaxRetriesExceeded` after exhaustion.
- **Rate Limiting:** Sliding window enforcement.
    -   Tracks requests per minute and per hour.
    -   Automatically pauses execution or raises `RateLimitExceeded`.
    -   Configured per-source in `sources.yaml`.

---

## 3. The Frontend (`web/`)

The user-facing application.

**Tech Stack:**
- **Framework:** Next.js 16.1.1 (App Router)
- **Language:** TypeScript
- **UI:** React 19, Tailwind CSS v4
- **Database:** Prisma 5.22.0 (SQLite)
- **Icons:** Lucide React

**Architecture:**
- **App Router:** Next.js 15 structure.
- **Data Access:** Direct DB access via Prisma (Server Components).
- **Styling:** Tailwind CSS.
- **Database:** Shared SQLite database (`dev.db`) with the Python engine.

---

## 4. Configuration & Operations

### 4.1 Monitoring & Alerts
*Source: `engine/config/monitoring_alerts.yaml`*

**Critical Thresholds:**
| Alert Name | Metric | Threshold | Action |
| :--- | :--- | :--- | :--- |
| High Extraction Failure Rate | `extraction_failure_rate` | > 10% | Check health dashboard, logs, API keys |
| Database Connection Failures | `database_connection_errors` | > 0 | Verify DB running, connection string |
| Disk Space Critical | `disk_space_free_percent` | < 10% | Clean up raw data/logs |
| LLM API Authentication Failure | `llm_api_auth_errors` | 3 failures | Check API key, quota |

**Performance Targets:**
- **Throughput:** Target 60 records/hour, Min 20.
- **LLM Cost:** Target £0.30/100 records, Max £0.50.
- **Success Rate:** Deterministic > 95%, LLM > 85%.
- **Cache Hit:** Target 40%, Min 20%.

### 4.2 Quality Assurance
- **Quarantine:** Failed extractions are caught by `record_failed_extraction` and stored in the `FailedExtraction` table. They can be inspected and retried using the CLI.
- **Cost Tracking:** The `cost_report.py` module tracks token usage and estimates costs based on model pricing. CLI available to view reports.

### 4.3 Testing Strategy
*Source: `conftest.py`, `engine/tests/`*

The project uses `pytest` for the backend.
- **Root `conftest.py`:** Adds project root to `sys.path` for module resolution.
- **Engine Tests:** Located in `engine/tests/`, covering connectors, extractors, and utility logic.
- **Frontend Tests:** Configured via `package.json` (currently minimal/standard Next.js setup).

---

## 5. Developer Tools (CLI Reference)

### 5.1 Ingestion CLI (`engine/ingestion/cli.py`)
`python -m engine.ingestion.cli <command>`

- `python -m engine.ingestion.cli <connector> "<query>"`: Run a specific connector (e.g., `serper "padel"`).
- `python -m engine.ingestion.cli status`: Show comprehensive ingestion stats.
- `python -m engine.ingestion.cli --list`: List available connectors.
- `python -m engine.ingestion.cli -v ...`: Enable verbose output.

### 5.2 Extraction CLI (`engine/extraction/cli.py`)
`python -m engine.extraction.cli <command>`

- `--retry-failed`: Retry failed extractions in quarantine.
- `--max-retries <N>`: Set max retries (default 3).
- `--limit <N>`: Limit number of items to retry.

### 5.3 Schema CLI (`engine/schema/cli.py`)
`python -m engine.schema.generate <options>`

- No args: Generate all schemas (Python + Prisma).
- `--validate`: Check if generated files match YAML (for CI).
- `--schema <name>`: Generate specific schema (e.g., `listing`).
- `--typescript`: Generate TypeScript interfaces.
- `--pydantic-extraction`: Generate Pydantic models.
- `--prisma` / `--no-prisma`: Control Prisma generation.
- `--format`: Run code formatter on output.

### 5.4 Utility Scripts
- `python -m engine.run_seed`: Seed the DB with initial data.
- `python -m engine.inspect_db`: Debug tool to view DB rows.
- `python -m engine.check_data`: Validation tool.

---

## 6. Documentation Index

A guide to the specialized documents in `docs/`.

| File | Description |
| :--- | :--- |
| `architecture/` | C4 Architecture diagrams and descriptions. |
| `product/` | Product Requirements Documents (PRD) and design guidelines. |
| `adding_entity_type.md` | Guide for adding new entity types to the system. |
| `adding_new_extractor.md` | Guide for implementing new data extractors. |
| `category_promotion_workflow.md` | Details on the taxonomy mapping process. |
| `configuring_trust_levels.md` | How to configure source trust scores. |
| `extraction_cli.md` | Detailed manual for the Extraction CLI. |
| `extraction_cli_reference.md` | Quick reference for Extraction CLI commands. |
| `extraction_engine_overview.md` | High-level overview of the extraction pipeline. |
| `managing_categories.md` | Guide to managing the canonical taxonomy. |
| `production_deployment_checklist.md` | Checklist for going to production. |
| `schema_management.md` | Guide to the YAML-based schema system. |
| `snapshot_testing_workflow.md` | Guide for snapshot testing. |
| `SYSTEM_DESIGN_MANUAL.md` | **This file.** The authoritative system manual. |
| `troubleshooting_extraction.md` | Common issues and solutions for extraction. |
| `tuning_llm_prompts.md` | Guide for optimizing LLM extraction prompts. |

---

## 7. Extensibility Workflows

### Workflow: Add a New Entity Type
1.  **Create Schema:** Add `engine/config/schemas/<entity_name>.yaml`.
2.  **Generate:** `python -m engine.schema.generate`.
3.  **Migrate:** `npx prisma migrate dev`.

### Workflow: Add a New Category
1.  **Analyze:** Check `logs/unmapped_categories.log`.
2.  **Edit:** `engine/config/canonical_categories.yaml`.
3.  **Deploy:** Changes apply on next extraction.