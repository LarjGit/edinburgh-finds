# System Design & Configuration Manual

*This document is the "System Bible" for Edinburgh Finds. It covers the architecture, configuration, operational tools, and logic of the entire repository. Generated by the `generate-system-manual` skill.*

---

## 1. System Overview

Edinburgh Finds is a hyper-local discovery platform built on a "Universal Entity Framework."

### High-Level Architecture
- **Monorepo Structure:**
    - `engine/`: Python-based data processing (Ingestion, Extraction, AI).
    - `web/`: Next.js frontend (User Interface).
    - `prisma/`: Shared database schema.
    - `docs/`: Specialized documentation.

---

## 2. The Data Engine ("The Brain")

The core value of the platform lies in its ability to turn messy web data into structured, trusted entities.

### 2.1 Taxonomy & Classification
*Source: `engine/config/canonical_categories.yaml`*

The system maps chaotic inputs to a strict taxonomy using a "Promotion Workflow."

**Taxonomy Logic:**
Raw categories from extractors are mapped to canonical categories using regex-based rules defined in `mapping_rules`. Each rule has a confidence score (0.0-1.0). The system requires a minimum confidence (default 0.7) to apply a mapping. Unmapped categories are logged to `logs/unmapped_categories.log` for manual review, allowing the taxonomy to evolve. The philosophy prioritizes specificity and a flat, tag-based structure.

**Current Hierarchy:**
- **Entity Types**
  - Venue
  - Retail
  - Coach
  - Club
  - Event
- **Sports**
  - Padel
  - Tennis
  - Squash
  - Badminton
  - Pickleball
  - Table Tennis
- **Venue Subtypes**
  - Sports Centre
  - Gym
  - Swimming Pool
  - Outdoor Pitch
  - Private Club
  - Public Facility
- **Additional Sports**
  - Golf
  - Climbing
  - Yoga
  - Martial Arts

### 2.2 Deduplication & Merging
*Source: `engine/extraction/deduplication.py`, `engine/extraction/merging.py`*

**Deduplication Strategy:**
The system employs a cascade of three strategies to identify duplicates:
1.  **External ID Matching (100% Confidence):** Matches based on shared IDs from providers like Google Place ID or OSM ID.
2.  **Slug Matching:** Checks for exact or highly similar URL-safe identifiers (slugs).
3.  **Fuzzy Matching:** Combines name similarity (Token Sort Ratio) and geographic proximity (Haversine distance). Matches require a combined score above a threshold (default 0.85), where name weight is 0.7 and location weight is 0.3.

**Merging & Trust Levels:**
When sources conflict, "Trust Levels" decide the winner.

| Source | Trust Score |
| :--- | :--- |
| manual_override | 100 |
| sport_scotland | 90 |
| edinburgh_council | 85 |
| google_places | 70 |
| serper | 50 |
| osm | 40 |
| open_charge_map | 40 |
| unknown_source | 10 |

### 2.3 The LLM Cache
*Source: `engine/extraction/llm_cache.py`*

Semantic caching minimizes costs and latency.
The system calculates a deterministic cache key using SHA-256 hash of the raw data (sorted JSON), the extraction prompt, and the model name. Cache entries are stored in the `ExtractedListing` table. A cache hit returns the existing structured data immediately, bypassing the LLM.

### 2.4 Pipeline Resilience
*Source: `engine/ingestion/retry_logic.py`, `engine/ingestion/rate_limiting.py`*

- **Retry Logic:** Implements an exponential backoff strategy. If a transient error occurs, the system waits for an increasing duration (`initial_delay * backoff_factor^attempt`) before retrying, capped at `max_delay`. Default is 3 retries.
- **Rate Limiting:** Uses a sliding window approach (tracking requests per minute and hour) to comply with external API limits. The `RateLimiter` class ensures that specific source limits defined in `sources.yaml` are not exceeded.

---

## 3. The Frontend (`web/`)

The user-facing application.

**Tech Stack:**
- **Framework:** Next.js 16.1.1 (App Router)
- **Language:** TypeScript
- **Styling:** Tailwind CSS v4, `clsx`, `tailwind-merge`
- **Database:** Prisma 5.22.0 (SQLite)
- **Icons:** Lucide React

**Architecture:**
- **App Router:** Utilizes the modern Next.js 15+ structure.
- **Data Access:** Server Components access the shared SQLite database (`web/dev.db`) directly via Prisma.
- **Styling:** Utility-first CSS with Tailwind.

---

## 4. Configuration & Operations

### 4.1 Monitoring & Alerts
*Source: `engine/config/monitoring_alerts.yaml`*

**Critical Thresholds:**

| Alert Name | Metric | Threshold |
| :--- | :--- | :--- |
| High Extraction Failure Rate | `extraction_failure_rate` | > 10% |
| Database Connection Failures | `database_connection_errors` | >= 1 |
| Disk Space Critical | `disk_space_free_percent` | < 10% |
| LLM API Authentication Failure | `llm_api_auth_errors` | >= 3 |

**Performance Targets:**
- **Throughput:** Target 60 records/hour, Minimum 20.
- **LLM Cost:** Target £0.30 per 100 records, Max £0.50.
- **Success Rate:** Deterministic > 95%, LLM > 85%.
- **Cache Hit Rate:** Target 40%, Min 20%.

### 4.2 Quality Assurance
- **Quarantine:** Failed extractions are caught and stored in the `FailedExtraction` table with error details. They are isolated ("quarantined") to prevent pipeline blockage. The `ExtractionRetryHandler` can re-process these records.
- **Cost Tracking:** The `cost_report.py` module aggregates token usage from the global tracker and calculates costs based on model pricing, available via the CLI.

### 4.3 Testing Strategy
*Source: `conftest.py`, `engine/tests/`*

The project uses `pytest` for the backend.
- **Configuration:** `conftest.py` adds the project root to `sys.path` to allow module imports during tests.
- **Scope:** Includes unit tests for utility functions (e.g., deduplication, splitters) and integration tests for connectors and extractors.
- **Snapshots:** Snapshot testing is used for verifying extraction outputs against expected schemas.

---

## 5. Developer Tools (CLI Reference)

### 5.1 Ingestion CLI (`engine/ingestion/cli.py`)
`python -m engine.ingestion.cli <command>`

- `python -m engine.ingestion.cli <connector> <query>`: Run a specific connector (e.g., `serper`, `google_places`).
- `python -m engine.ingestion.cli status`: Show comprehensive ingestion statistics (success rates, breakdown by source).
- `python -m engine.ingestion.cli --list`: List available connectors.

### 5.2 Extraction CLI (`engine/extraction/cli.py`)
`python -m engine.extraction.cli <command>`

- `python -m engine.extraction.cli --retry-failed`: Retry failed extractions currently in quarantine.
- `python -m engine.extraction.cli --retry-failed --max-retries N`: Retry items with fewer than N prior retries.
- `python -m engine.extraction.cli --retry-failed --limit N`: Retry a batch of N items.

### 5.3 Schema CLI (`engine/schema/cli.py`)
`python -m engine.schema.cli <command>`

- `python -m engine.schema.generate`: Generate Python `FieldSpec` definitions from YAML schemas.
- `python -m engine.schema.generate --typescript`: Generate TypeScript interfaces.
- `python -m engine.schema.generate --typescript --zod`: Include Zod validation schemas.
- `python -m engine.schema.generate --validate`: Verify generated code matches YAML definitions.
- `python -m engine.schema.generate --schema <name>`: Generate for a specific schema only.

### 5.4 Utility Scripts
- `python -m engine.run_seed`: Seed the DB with initial data.
- `python -m engine.inspect_db`: Debug tool to view DB rows.
- `python -m engine.check_data`: Validation tool.

---

## 6. Documentation Index

A guide to the specialized documents in `docs/`.

| File | Description |
| :--- | :--- |
| `architecture/` | C4 Architecture Diagrams (Context, Container, Component). |
| `product/` | Product Requirements Documents (PRD) and design guidelines. |
| `SYSTEM_DESIGN_MANUAL.md` | This file. The central system reference. |
| `adding_entity_type.md` | Guide for creating new entities (Schema -> Code -> DB). |
| `adding_new_extractor.md` | How to implement a new data extractor. |
| `category_promotion_workflow.md` | Details on the taxonomy promotion and mapping process. |
| `configuring_trust_levels.md` | Guide to tuning source authority and merging logic. |
| `extraction_cli.md` | Detailed manual for the extraction CLI. |
| `extraction_cli_reference.md` | Quick reference for extraction commands. |
| `extraction_engine_overview.md` | High-level architectural view of the engine. |
| `managing_categories.md` | Operational guide for taxonomy management. |
| `production_deployment_checklist.md` | Pre-flight checks for deployment. |
| `schema_management.md` | Overview of the YAML-driven schema system. |
| `snapshot_testing_workflow.md` | How to use and update test snapshots. |
| `troubleshooting_extraction.md` | Debugging guide for common extraction issues. |
| `tuning_llm_prompts.md` | Best practices for optimizing LLM performance and cost. |

---

## 7. Extensibility Workflows

### Workflow: Add a New Entity Type
1.  **Create Schema:** Add `engine/config/schemas/<entity_name>.yaml`.
2.  **Generate:** `python -m engine.schema.generate`.
3.  **Migrate:** `npx prisma migrate dev`.

### Workflow: Add a New Category
1.  **Analyze:** Check `logs/unmapped_categories.log`.
2.  **Edit:** `engine/config/canonical_categories.yaml`.
3.  **Deploy:** Changes apply on next extraction extraction run.
