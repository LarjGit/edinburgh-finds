graph LR
    subgraph Public["Public Internet"]
        User["User Browser"]
        ExtAPI1["Serper API<br/>(HTTPS)"]
        ExtAPI2["Google Places API<br/>(HTTPS)"]
        ExtAPI3["OpenStreetMap<br/>Overpass API<br/>(HTTPS)"]
        ExtAPI4["SportScotland API<br/>(HTTPS)"]
        ExtAPI5["EventBrite API<br/>(HTTPS)"]
        ExtAPI6["Anthropic Claude API<br/>(HTTPS)"]
    end

    subgraph Internal["Internal Application Network"]
        subgraph Web["Next.js Web Application"]
            WebApp["Next.js Server<br/>(Port 3000)"]
            API["API Routes<br/>/api/*"]
        end

        subgraph Engine["Python Engine"]
            Orchestrator["Query Orchestration<br/>(Planner + Registry)"]
            Connectors["Connector Layer<br/>(6 Data Sources)"]
            Extractors["Extraction Engine<br/>(Hybrid Rules + LLM)"]
            LensEngine["Lens Application<br/>(Canonical Mapping)<br/>⚠️ Partial Implementation"]
            Merge["Merge & Finalization<br/>(Deduplication)"]
        end

        subgraph Data["Database Layer"]
            DB["PostgreSQL<br/>(Supabase)<br/>Prisma Client"]
        end
    end

    %% User flows
    User -->|"HTTPS"| WebApp
    WebApp -->|"Server-Side Rendering"| User

    %% Web App internal flows
    WebApp -->|"API Calls"| API
    API -->|"Prisma ORM"| DB

    %% Web App reads finalized entities only (Engine invoked via CLI)
    API -->|"GET /api/entities/:slug"| DB
    API -->|"GET /api/entities?filter=..."| DB

    %% Engine internal pipeline
    Orchestrator -->|"Phase-based<br/>Execution Plan"| Connectors
    Connectors -->|"Raw Payloads"| DB
    Extractors -->|"ExtractedEntity<br/>Records"| DB
    LensEngine -->|"Canonical<br/>Dimensions"| Merge
    Merge -->|"Entity Upsert<br/>(Idempotent)"| DB

    %% Connectors → External APIs
    Connectors -->|"HTTPS<br/>API Key:<br/>SERPER_API_KEY"| ExtAPI1
    Connectors -->|"HTTPS<br/>API Key:<br/>GOOGLE_PLACES_API_KEY"| ExtAPI2
    Connectors -->|"HTTPS<br/>Public API"| ExtAPI3
    Connectors -->|"HTTPS<br/>Public/API Key"| ExtAPI4
    Connectors -->|"HTTPS<br/>Public API"| ExtAPI5

    %% LLM extraction
    Extractors -->|"HTTPS<br/>API Key:<br/>ANTHROPIC_API_KEY<br/>Instructor SDK"| ExtAPI6
    LensEngine -->|"HTTPS<br/>Schema-Bound<br/>Extraction"| ExtAPI6

    %% Engine ↔ Database
    Orchestrator -->|"Prisma Client<br/>Python"| DB
    Extractors -->|"Prisma Client<br/>Python"| DB

    %% Styling
    classDef publicNode fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    classDef webNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef engineNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef dbNode fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef apiNode fill:#fce4ec,stroke:#c2185b,stroke-width:2px

    class User,ExtAPI1,ExtAPI2,ExtAPI3,ExtAPI4,ExtAPI5,ExtAPI6 publicNode
    class WebApp,API webNode
    class Orchestrator,Connectors,Extractors,LensEngine,Merge engineNode
    class DB dbNode
