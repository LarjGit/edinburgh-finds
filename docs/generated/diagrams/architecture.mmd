```mermaid
graph TB
    %% Applications Layer (Top)
    subgraph Applications["<b>APPLICATIONS LAYER</b><br/>(Vertical-Specific)"]
        EF["Edinburgh Finds<br/>(Reference Lens)"]
        Wine["Wine Discovery<br/>(Future)"]
        Rest["Restaurant Finder<br/>(Future)"]
        Events["Events Platform<br/>(Future)"]
    end

    %% Lens Layer
    subgraph LensLayer["<b>LENS LAYER</b><br/>(Domain-Aware Interpretation)"]
        direction TB
        Vocab["<b>Vocabulary</b><br/>• Activity Keywords<br/>• Location Indicators<br/>• Role Keywords"]
        ConnRules["<b>Connector Routing Rules</b><br/>• Priority Triggers<br/>• Phase Assignment<br/>• Budget Control"]
        MapRules["<b>Mapping Rules</b><br/>• Pattern → Canonical<br/>• Confidence Scoring<br/>• Evidence-Based"]
        ModTriggers["<b>Module Triggers</b><br/>• Conditional Attachment<br/>• Domain-Specific Logic"]
        CanonRegistry["<b>Canonical Registry</b><br/>• Display Names<br/>• SEO Slugs<br/>• Icons & Metadata"]
    end

    %% Engine Layer (Domain-Blind Universal Platform)
    subgraph EngineLayer["<b>ENGINE LAYER</b><br/>(Domain-Blind Universal Platform)"]
        direction TB

        subgraph Orch["<b>1. ORCHESTRATION</b>"]
            Planner["Query Planner<br/>(Feature Detection)"]
            ConnRouter["Connector Router<br/>(Execution Plan)"]
            BudgetMgr["Budget Manager<br/>(Rate Limits)"]
        end

        subgraph Ingest["<b>2. INGESTION</b>"]
            Adapters["Connector Adapters<br/>(Interface Bridge)"]
            RawFetch["Raw Data Fetching<br/>(Parallel Execution)"]
            DedupRaw["Ingestion Dedup<br/>(Artifact Identity)"]
        end

        subgraph Extract["<b>3. EXTRACTION</b>"]
            P1Extract["Phase 1: Primitives<br/>(Schema Primitives + Raw Observations)"]
            P2Lens["Phase 2: Lens Application<br/>(Canonical Dimension Population)"]
        end

        subgraph Classification["<b>4. CLASSIFICATION</b>"]
            EntityClass["Entity Class Assignment<br/>(place/person/organization/event/thing)"]
        end

        subgraph Modules["<b>5. MODULE ATTACHMENT</b>"]
            ModuleTrigger["Module Trigger Evaluation<br/>(Lens Contract-Driven)"]
            ModulePopulate["Module Field Population<br/>(Field Rules Engine)"]
        end

        subgraph Dedup["<b>6. DEDUPLICATION & MERGE</b>"]
            CrossDedup["Cross-Source Dedup<br/>(Grouping by Identity)"]
            DetMerge["Deterministic Merge<br/>(Connector-Blind, Metadata-Driven)"]
            Provenance["Provenance Tracking<br/>(Multi-Source)"]
        end

        subgraph Persist["<b>7. PERSISTENCE</b>"]
            Finalizer["Entity Finalizer<br/>(Slug Generation)"]
            Upsert["Idempotent Upsert<br/>(Schema-Aligned)"]
            IndexMgr["Index Manager<br/>(GIN Arrays)"]
        end

        subgraph LensEngine["<b>LENS ENGINE</b><br/>(Configuration Runtime)"]
            LensLoader["Lens Loader<br/>(Bootstrap Only)"]
            LensValidator["Contract Validator<br/>(Fail-Fast)"]
            ExecContext["Execution Context<br/>(Immutable Carrier)"]
        end
    end

    %% Data Storage Layer
    subgraph Storage["<b>DATA STORAGE LAYER</b><br/>(PostgreSQL via Supabase)"]
        direction LR
        RawIngestion["<b>RawIngestion</b><br/>• source<br/>• payload<br/>• hash<br/>• timestamp"]
        ExtractedEntity["<b>ExtractedEntity</b><br/>• primitives<br/>• raw_observations<br/>• confidence"]
        Entity["<b>Entity</b><br/>• entity_class<br/>• canonical_*[]<br/>• modules (JSONB)<br/>• provenance"]
    end

    %% External Sources Layer
    subgraph Sources["<b>EXTERNAL DATA SOURCES</b><br/>(6 Connectors)"]
        direction LR
        Serper["Serper<br/>(Web Search)"]
        GPlaces["Google Places<br/>(Places API)"]
        OSM["OpenStreetMap<br/>(Geo Data)"]
        SportScot["Sport Scotland<br/>(Facilities)"]
        Custom1["Custom Scrapers<br/>(Vertical-Specific)"]
        Future["Future Connectors<br/>(Unlimited)"]
    end

    %% Data Flow Connections
    Applications --> LensLayer
    LensLayer --> Orch

    Orch --> Ingest
    Sources --> RawFetch

    Ingest --> RawIngestion
    RawIngestion --> Extract

    Extract --> Classification
    Classification --> Modules

    LensEngine --> P2Lens
    LensEngine --> ModuleTrigger
    LensEngine --> ModulePopulate

    Modules --> ExtractedEntity
    ExtractedEntity --> Dedup

    Dedup --> Persist
    Persist --> Entity

    %% Key Boundaries
    LensLayer -.->|"Configuration Only<br/>(No Code Changes)"| EngineLayer

    %% Styling
    classDef appLayer fill:#e1f5ff,stroke:#0066cc,stroke-width:2px,color:#000
    classDef lensLayer fill:#fff4e6,stroke:#ff9800,stroke-width:2px,color:#000
    classDef engineLayer fill:#e8f5e9,stroke:#4caf50,stroke-width:2px,color:#000
    classDef storageLayer fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px,color:#000
    classDef sourceLayer fill:#fce4ec,stroke:#e91e63,stroke-width:2px,color:#000

    class Applications appLayer
    class LensLayer lensLayer
    class EngineLayer engineLayer
    class Storage storageLayer
    class Sources sourceLayer
```
