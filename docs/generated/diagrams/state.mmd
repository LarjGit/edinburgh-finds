stateDiagram-v2
    %% Universal Entity Extraction Engine - State Transitions & Execution Flow

    %% Entity Lifecycle States
    [*] --> QuerySubmitted: User submits query

    QuerySubmitted --> LensResolved: Lens resolution & validation
    LensResolved --> PlanCreated: Orchestrator creates execution plan
    PlanCreated --> ConnectorExec: Dispatch connectors by phase

    ConnectorExec --> RawDataIngested: All connectors complete
    RawDataIngested --> Extracted: Per-source extraction

    Extracted --> LensMapped: Apply mapping rules
    LensMapped --> Classified: Determine entity_class

    Classified --> Deduplicated: Cross-source grouping
    Deduplicated --> Merged: Deterministic merge

    Merged --> Finalized: Generate slugs, upsert
    Finalized --> [*]: Entity persisted

    %% Failure paths
    LensResolved --> [*]: Lens validation fails
    ConnectorExec --> PartialIngestion: Some connectors fail
    PartialIngestion --> RawDataIngested: Continue with available data
    Extracted --> [*]: Critical extraction failure
    Merged --> [*]: Persistence failure

    %% Connector Execution States (nested within dispatch phase)
    state "Connector Execution" as ConnectorExec {
        [*] --> Planned
        Planned --> Queued: Added to phase queue
        Queued --> Executing: Connector invoked

        Executing --> RateLimited: Rate limit hit
        RateLimited --> Executing: Retry after backoff

        Executing --> Success: Data returned
        Executing --> Timeout: Execution timeout
        Executing --> Failed: Network/API error

        Success --> Persisting: Save raw artifact
        Persisting --> Completed: Artifact persisted

        Completed --> [*]
        Timeout --> [*]
        Failed --> [*]
    }

    %% Annotations
    note right of LensResolved
        Bootstrap validation gates:
        - Schema validation
        - Canonical registry integrity
        - Connector references
        - Regex compilation
    end note

    note right of Extracted
        Phase 1 (Extractors):
        Schema primitives + raw observations only
        NO canonical_* or modules
    end note

    note right of LensMapped
        Phase 2 (Lens Application):
        Populate canonical dimensions
        Execute module triggers
        Deterministic rules first
    end note

    note right of Merged
        Deterministic merge cascade:
        trust_tier → quality → confidence
        → completeness → priority → connector_id
    end note
