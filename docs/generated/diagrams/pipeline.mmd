%% Universal Entity Extraction Engine — Data Pipeline
%% AUTO-GENERATED: 2026-02-08
%% This diagram shows the complete 11-stage execution pipeline from query to entity persistence

graph TD
    %% ===== STAGE 1: INPUT =====
    Input["<b>1. Input</b><br/>Query or Entity Identifier"]

    %% ===== STAGE 2: LENS RESOLUTION =====
    Input --> LensResolution["<b>2. Lens Resolution + Validation</b><br/>• Resolve lens_id (CLI → env → config → fallback)<br/>• Load lens.yaml<br/>• Validate schema, references, canonical registry<br/>• Compile regex patterns<br/>• Compute lens hash<br/>• Create ExecutionContext (immutable)"]

    LensResolution -->|Invalid Lens| LensFail[❌ Fail Fast<br/>Abort Execution]

    %% ===== STAGE 3: PLANNING =====
    LensResolution -->|Valid Lens| Planning["<b>3. Planning / Orchestration</b><br/>• Derive query features (deterministic)<br/>• Apply lens connector_rules<br/>• Select connector execution plan<br/>• Establish phases, budgets, ordering"]

    %% ===== STAGE 4: CONNECTOR EXECUTION =====
    Planning --> ConnectorExec["<b>4. Connector Execution</b><br/>• Execute connectors per plan<br/>• Enforce rate limits, timeouts<br/>• Collect raw payloads + metadata"]

    ConnectorExec --> RawPayload1[("Raw Payload<br/>(Serper)")]
    ConnectorExec --> RawPayload2[("Raw Payload<br/>(GooglePlaces)")]
    ConnectorExec --> RawPayload3[("Raw Payload<br/>(OSM)")]
    ConnectorExec --> RawPayloadN[("Raw Payload<br/>(SportScotland, etc.)")]

    %% ===== STAGE 5: RAW INGESTION PERSISTENCE =====
    RawPayload1 --> RawIngestion["<b>5. Raw Ingestion Persistence</b><br/>• Persist raw artifacts (source, timestamp, hash)<br/>• Ingestion-level deduplication<br/>• Artifacts become immutable"]
    RawPayload2 --> RawIngestion
    RawPayload3 --> RawIngestion
    RawPayloadN --> RawIngestion

    RawIngestion --> RawDB[("RawIngestion Table<br/>(Immutable)")]

    %% ===== STAGE 6: SOURCE EXTRACTION =====
    RawDB --> SourceExtraction["<b>6. Source Extraction</b><br/>• Source-specific extractors run per artifact<br/>• Emit ONLY schema primitives + raw observations<br/>• entity_name, latitude, longitude, street_address,<br/>  phone, website_url, raw_categories, description<br/>• FORBIDDEN: canonical_*, modules<br/>• NO domain semantics"]

    SourceExtraction --> ExtractedEntity1[("ExtractedEntity<br/>(primitives + raw obs)")]

    %% ===== STAGE 7: LENS APPLICATION =====
    ExtractedEntity1 --> LensApplication["<b>7. Lens Application</b><br/>• Apply lens mapping_rules → populate canonical_*<br/>• Evaluate module_triggers<br/>• Execute module field_rules (deterministic first)<br/>• Default evidence surfaces: entity_name, summary,<br/>  description, raw_categories, street_address<br/>• LLM extraction (schema-bound, batched)"]

    LensApplication --> EnrichedEntity[("Enriched Entity<br/>(primitives + canonical_* + modules)")]

    %% ===== STAGE 8: CLASSIFICATION =====
    EnrichedEntity --> Classification["<b>8. Classification + Module Attachment</b><br/>• Determine entity_class (universal rules)<br/>• Place = any geographic anchoring present<br/>  (coordinates, street_address, city, postcode)<br/>• Attach triggered modules"]

    Classification --> ClassifiedEntity[("Classified Entity<br/>(with entity_class)")]

    %% ===== STAGE 9: DEDUPLICATION =====
    ClassifiedEntity --> Deduplication["<b>9. Cross-Source Deduplication Grouping</b><br/>• Multi-tier strategies:<br/>  - External identifiers<br/>  - Geo similarity<br/>  - Normalized name similarity<br/>  - Content fingerprints<br/>• Group entities by real-world identity"]

    Deduplication --> DedupGroup[("Deduplication Groups<br/>(immutable)")]

    %% ===== STAGE 10: MERGE =====
    DedupGroup --> Merge["<b>10. Deterministic Merge</b><br/>• Pre-sort by (-trust, connector_id, id)<br/>• Field-aware merge strategies:<br/>  - Identity fields: higher trust + completeness<br/>  - Geo fields: precision → trust → decimal precision<br/>  - Contact fields: quality score → trust<br/>  - Canonical arrays: union + deduplicate + sort<br/>  - Modules: recursive merge with trust priority<br/>  - Provenance: always union<br/>• Deterministic tie-break cascade"]

    Merge --> MergedEntity[("Merged Entity<br/>(single canonical entity per group)")]

    %% ===== STAGE 11: FINALIZATION =====
    MergedEntity --> Finalization["<b>11. Finalization + Persistence</b><br/>• Generate stable slugs (URL-safe)<br/>• Create derived identifiers<br/>• Upsert entities (idempotent)<br/>• Persist provenance + external IDs<br/>• MUST use canonical schema keys only<br/>• FORBIDDEN: legacy keys (location_lat, etc.)"]

    Finalization --> EntityDB[("Entity Table<br/>(Canonical Storage)")]

    %% ===== VALIDATION & OBSERVABILITY =====
    EntityDB -.->|Validation Signal| Validation["<b>Validation</b><br/>• One Perfect Entity (OPE) requirement<br/>• At least one multi-source merge<br/>• Correct entity_class<br/>• Non-empty canonical_* (where evidence exists)<br/>• ≥1 module field populated<br/>• Provenance preserved"]

    %% ===== METADATA FLOW =====
    LensResolution -.->|ExecutionContext<br/>(lens_id, lens_contract, lens_hash)| Planning
    Planning -.->|ExecutionContext| ConnectorExec
    ConnectorExec -.->|ExecutionContext| SourceExtraction
    SourceExtraction -.->|ExecutionContext| LensApplication

    %% ===== ARTIFACT IMMUTABILITY =====
    RawDB -.->|Immutable| SourceExtraction
    ExtractedEntity1 -.->|Immutable| LensApplication
    EnrichedEntity -.->|Immutable| Classification
    ClassifiedEntity -.->|Immutable| Deduplication
    DedupGroup -.->|Immutable| Merge
    MergedEntity -.->|Immutable| Finalization

    %% ===== STYLING =====
    classDef input fill:#e1f5ff,stroke:#333,stroke-width:2px
    classDef lens fill:#fff4e6,stroke:#333,stroke-width:2px
    classDef orchestration fill:#f0f9ff,stroke:#333,stroke-width:2px
    classDef connector fill:#dbeafe,stroke:#333,stroke-width:2px
    classDef extraction fill:#fef3c7,stroke:#333,stroke-width:2px
    classDef canonical fill:#dcfce7,stroke:#333,stroke-width:2px
    classDef persistence fill:#e0e7ff,stroke:#333,stroke-width:2px
    classDef artifact fill:#f3f4f6,stroke:#666,stroke-width:1px,stroke-dasharray: 5 5
    classDef database fill:#fce7f3,stroke:#333,stroke-width:2px
    classDef fail fill:#fee2e2,stroke:#dc2626,stroke-width:2px
    classDef validation fill:#fef3c7,stroke:#333,stroke-width:1px,stroke-dasharray: 3 3

    class Input input
    class LensResolution lens
    class Planning,ConnectorExec orchestration
    class RawIngestion,SourceExtraction extraction
    class LensApplication,Classification canonical
    class Deduplication,Merge,Finalization persistence
    class RawPayload1,RawPayload2,RawPayload3,RawPayloadN,ExtractedEntity1,EnrichedEntity,ClassifiedEntity,DedupGroup,MergedEntity artifact
    class RawDB,EntityDB database
    class LensFail fail
    class Validation validation
