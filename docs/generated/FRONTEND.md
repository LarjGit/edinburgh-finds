# Frontend Architecture

**Generated:** 2026-02-06
**Status:** Auto-generated documentation

---

## Overview

The frontend is a **Next.js 16** application using the **App Router** with **React 19**, **TypeScript**, and **Tailwind CSS v4**. It connects to a PostgreSQL database via **Prisma 7.3+** for server-side data fetching.

The frontend is currently in an early stage — it serves as a validation layer for the entity data produced by the Python engine.

---

## Project Structure

```
web/
├── app/                       # Next.js App Router
│   ├── layout.tsx             # Root layout (Geist fonts, global styles)
│   ├── page.tsx               # Home page — entity listing with dimensions
│   └── globals.css            # Global styles + Tailwind CSS
│
├── lib/                       # Shared utilities
│   ├── prisma.ts              # Prisma client singleton
│   ├── entity-queries.ts      # Faceted query builder (buildFacetedWhere)
│   ├── entity-helpers.ts      # Entity data parsing utilities
│   ├── lens-query.ts          # Lens-aware query utilities
│   ├── utils.ts               # General utilities (parseAttributesJSON, etc.)
│   ├── lens-query.test.ts     # Lens query tests
│   ├── utils.test.ts          # Utility tests
│   └── types-test.ts          # Type tests
│
├── prisma/
│   ├── schema.prisma          # GENERATED — do not edit directly
│   ├── migrations/            # PostgreSQL migrations
│   ├── migrations_sqlite_backup/ # Historical SQLite migrations
│   ├── dev.db                 # Local SQLite dev database (legacy)
│   └── dev.db-journal
│
├── package.json               # Dependencies and scripts
├── tsconfig.json              # TypeScript configuration
├── next.config.ts             # Next.js configuration
├── postcss.config.mjs         # PostCSS (Tailwind v4)
└── eslint.config.mjs          # ESLint configuration
```

---

## Key Components

### Root Layout (`app/layout.tsx`)

Sets up the HTML structure with Geist fonts (sans and mono) and global CSS.

```tsx
export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};
```

> **Note:** Metadata should be updated to reflect Edinburgh Finds branding.

### Home Page (`app/page.tsx`)

The main page performs server-side data fetching and renders entities with their dimensions and modules.

**Data flow:**
1. Server component calls `prisma.entity.findMany()` directly
2. Entities displayed with canonical dimension arrays and module data
3. Filtered query example demonstrates faceted search

**Features rendered:**
- Entity name and class badge
- Canonical dimensions (activities, roles, place types, access)
- Module data (JSON display)
- Schema attributes
- Discovered attributes count

---

## Prisma Client Setup (`lib/prisma.ts`)

Standard Next.js singleton pattern to prevent multiple Prisma clients in development:

```typescript
const prismaClientSingleton = () => new PrismaClient();

declare global {
  var prisma: undefined | ReturnType<typeof prismaClientSingleton>;
}

const prisma = globalThis.prisma ?? prismaClientSingleton();
export default prisma;

if (process.env.NODE_ENV !== 'production') globalThis.prisma = prisma;
```

---

## Faceted Query System (`lib/entity-queries.ts`)

The `buildFacetedWhere()` function builds Prisma queries for faceted entity filtering:

```typescript
interface FacetFilters {
  activities?: string[];    // OR within facet
  roles?: string[];
  place_types?: string[];
  access?: string[];
  entity_class?: string;
}

// Example: Find padel venues
const where = buildFacetedWhere({
  activities: ["padel"],
  entity_class: "place",
});
```

**Query semantics:**
- **OR within facet:** Entity matches if it has ANY of the specified values (using Prisma `hasSome`)
- **AND across facets:** Entity must match ALL specified facets

**Higher-level functions:**
- `queryEntitiesByFacets(prisma, filters, options)` — Execute a faceted query
- `countEntitiesByFacets(prisma, filters)` — Count matching entities

---

## Entity Helpers (`lib/entity-helpers.ts`)

Defensive utilities for working with PostgreSQL native types:

- `ensureArray(val)` — Ensures canonical dimension values are arrays
- `ensureModules(val)` — Ensures module JSONB data is an object
- `parseDimensionArray(val)` — Pass-through for backward compatibility
- `parseModules(val)` — Pass-through for backward compatibility

---

## Styling

The frontend uses **Tailwind CSS v4** with PostCSS:

- **Color scheme:** Dark mode support with zinc/blue palette
- **Layout:** Flexbox-based responsive design
- **Components:** Badge/tag patterns for entity classes and dimensions
- **Typography:** Geist Sans and Geist Mono fonts

Currently uses no component library (shadcn/ui is planned but not yet integrated).

---

## State Management

The application currently uses **no client-side state management**. All data is fetched server-side via Prisma in React Server Components.

Future plans may include:
- URL-based state for facet filters
- React Server Components for data mutations
- Possible Zustand or React Context for UI state

---

## Routing

The App Router is minimal:

| Route | Component | Description |
|-------|-----------|-------------|
| `/` | `app/page.tsx` | Entity listing with faceted filtering |

Future routes will likely include entity detail pages (`/entities/[slug]`), search pages, and vertical-specific views.

---

## API Integration

The frontend does **not** call a backend API. Instead, it queries the PostgreSQL database directly via Prisma Client JS in Server Components:

```tsx
// Server component — runs on the server
export default async function Home() {
  const entities = await prisma.entity.findMany({
    take: 5,
    select: { id: true, entity_name: true, /* ... */ },
  });
  return <ul>{/* render entities */}</ul>;
}
```

This is possible because the Python engine and Next.js frontend share the same database.

---

## Development Commands

```bash
cd web

# Install dependencies
npm install

# Start dev server (http://localhost:3000)
npm run dev

# Production build
npm run build

# Lint
npm run lint

# Prisma commands
npx prisma generate     # Generate Prisma client
npx prisma db push       # Sync schema to database
npx prisma migrate dev   # Create migration
npx prisma studio        # Database GUI
```

---

## Related Documentation

- **Database Schema:** [DATABASE.md](DATABASE.md)
- **Architecture:** [ARCHITECTURE.md](ARCHITECTURE.md)
- **Configuration:** [CONFIGURATION.md](CONFIGURATION.md) — DATABASE_URL setup
- **Onboarding:** [ONBOARDING.md](ONBOARDING.md) — Full setup guide
